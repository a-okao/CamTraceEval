# カメラ＋マーカー手先軌道評価システム

Python + OpenCV でマーカー付き手先の軌道を評価し、理想軌道（直線100mm / 円半径40mm）との誤差や所要時間を計測するツールです。ライブビュー上で計測開始/終了をキー操作し、結果を CSV とプロットで保存します。

## 1. 初回セットアップ

1. `config.yaml` を実環境に合わせて編集
   - `camera.device_id`: 使用するカメラ番号
   - `camera.calibrate_key`: キャリブレーションモードに入るキー（デフォルト `c`）
   - `marker.hsv_ranges`: 緑色マーカー用のHSV範囲。別色にしたい場合はここを変更
   - `marker.hsv_lower/hsv_upper`: 単一区間で使いたい場合のしきい値
   - `calibration`: スケール/オフセット or ホモグラフィ行列
   - `calibration.two_point_length_mm`: キャリブレーションでクリックする2点間を何mmとみなすか（デフォルト 100mm）
   - `trajectory`: 直線始点/終点、円の中心/半径
   - `output.base_dir` や `output.label` など
2. カメラを接続し、マーカーが映る位置にセット
3. 以下の手順に従ってアプリを起動

## 2. 使い方（計測フロー）

### 起動コマンド例
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install opencv-python numpy matplotlib pyyaml
```
その後、以下のいずれかを入力
- 直線軌道モード: `python main.py --mode LINE --label before`
- 円軌道モード: `python main.py --mode CIRCLE --label before`
- **円軌道モード (自動キャリブレーション):** `python main.py --mode CIRCLE --auto-circle --label auto_calibrated`
- 設定ファイルを変える場合: `python main.py --config your_config.yaml --mode LINE`
- 過去の計測結果を読み込む場合: `python main.py --mode CIRCLE --load outputs/mode_circle_before_20251208_123456.csv`
  - `--mode` は、読み込むCSVがどのモードで計測されたものかを示すために必要です。

### オプション設定
ウォームアップ回数や記録回数を変更したい場合は以下のオプションを使用します。

- `--warmup`: 記録開始前のウォームアップ（カウントのみ、記録なし）回数を指定（デフォルト: 3回）
- `--cycles`: 自動停止するまでの記録回数を指定（デフォルト: 5回）

**例: 1回のウォームアップ後に10回記録して自動停止**
```bash
python main.py --mode CIRCLE --warmup 1 --cycles 10
```

### ライブビュー操作
- `[s]`: 計測開始
- `[e]`: 計測終了（自動で保存）
- `[q]` または `ESC`: 中断終了
- 計測中でなくても検出したマーカー座標 (u,v) / (x,y) を表示。検出位置は赤の十字線で重畳描画（マーカーは緑色を想定）。
- `[c]`（デフォルト）: キャリブレーションモード。
   - LINE: マウス左クリックで2点を順に指定し、2点目で自動終了。1点目を原点、2点目を x=100mm（設定値）とみなし、以降の mm 座標を更新。クリックした2点を結ぶ直線をライブビューに表示。
   - CIRCLE: マウス左クリックで「円の外形上の1点 → 中心」を指定し、2点目で自動終了。クリックした2点から中心と半径を算出し、以降の mm 座標変換・誤差計算・軌跡描画に使用（クリック中心を原点とした mm 座標系）。ライブビューにキャリブ済みの円と中心を描画。
- `--auto-circle` オプション有効時（CIRCLEモードのみ）:
    - `[s]` キーで計測開始後、`AUTO-CAL` モードとして約5周分の軌道を自動的に記録。
    - 5周完了後、記録された軌道データから理想円を自動推定し、リアルタイムで描画を更新。
    - その後、自動的に計測をリセットし、`REC` モード（本番計測）へ移行します。本番計測開始に別途キー入力は不要です。
- `[k]`（デフォルト）: 色キャリブレーションモード。
  - マウスでクリックした位置の色から追跡用の新しいHSV範囲を自動設定。設定された範囲はコンソールに出力。
- 計測終了後、結果（RMSE/最大誤差/サンプル数/所要時間、出力ファイル名）を別ウィンドウに表示し、保存した軌跡・誤差プロット画像も別窓で開く。任意キーで全ウィンドウを閉じる。

### 出力
- CSV: `outputs/mode_<mode>_<label>_<timestamp>.csv`
- 軌跡プロット: `..._trajectory.png`
- 誤差プロット: `..._error.png`

## 3. 2回目以降の流れ

1. 前回の設定が有効なら `config.yaml` をそのまま使用。条件が変わる場合だけしきい値やキャリブを更新。
2. 必要なら `--label after` などラベルを変えて実行し、学習前後を区別。
3. 生成された CSV やプロットを比較し、誤差(RMSE/最大誤差)や所要時間を評価。

## 4. 参考情報
- 依存ライブラリ: `opencv-python`, `numpy`, `matplotlib`, `pyyaml`
- 実機テスト（カメラ接続）はユーザー側で実施してください。ライブビューが出ない場合は `camera.device_id` を変更して再試行してください。

## 5. 計測ロジック (Measurement Logic)

本システムにおける「直線の往復」と「円の周回」のカウント方法は以下のロジックで実装されています。

### 5.1. 直線往復 (LINE Mode)

始点 (p0) と終点 (p1) の間の距離を基準にしたステートマシンで判定しています。

*   **設定値:** `config.yaml` の `trajectory.endpoint_threshold_mm` (デフォルト: 5.0mm) が使用されます。これは、マーカーが始点または終点のエリア内にあると判断するための閾値です。
*   **判定ロジック:**
    1.  **開始 (Departure):** マーカーが始点 (p0) のエリア外に出て、動きが開始されたと判断されます。
    2.  **折り返し (Turn):** マーカーが終点 (p1) のエリア内に入った時点で、「復路」への折り返しと認識されます。
    3.  **完了 (Arrival):** マーカーが再び始点 (p0) のエリア内に入った時点で、1往復が完了したとカウントされます。

### 5.2. 円周回 (CIRCLE Mode)

円の中心に対するマーカーの「角度 (Angle)」を基準にしたステートマシンで判定しています。

*   **設定値:** 角度閾値 (約 ±15度) が内部で設定されており、特定の角度範囲を通過した際に状態が遷移します。
*   **判定ロジック:**
    1.  **開始:** マーカーが円軌道の特定の開始角度付近 (例: 0度 ±15度以内) を通過したときに、周回が開始されたと判断されます。
    2.  **中間地点:** マーカーが開始角度の反対側 (例: 180度 ±15度以内) を通過したことを検知します。
    3.  **完了:** マーカーが再び開始角度付近 (例: 0度 ±15度以内) を通過したときに、1周が完了したとカウントされます。

どちらのモードも、`main.py` 内のフレーム処理ループでリアルタイムにマーカーの座標を監視し、これらの状態遷移を管理して計測を行います。
